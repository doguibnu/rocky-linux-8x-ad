{"config":{"indexing":"full","lang":["pt"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Rocky Linux como AD-DC Nesta documenta\u00e7\u00e3o vamos abordar a instala\u00e7\u00e3o do SAMBA-AD-DC no sistema operacional Rocky Linux 8.x servindo como Active Directory e Controlador de Dom\u00ednio . Uma segunda m\u00e1quina, com o Rocky Linux 8.x, servindo como Replicador do AD agindo como uma m\u00e1quina de Backup do AD (sysvol). E por \u00faltimo, uma m\u00e1qina com Rocky Linux 8.x servindo como Membro e Servidor de Arquivos do AD . Por que o Rocky Linux? \"O Rocky Linux \u00e9 um sistema operacional empresarial de c\u00f3digo aberto projetado para ser 100% bug-a-bug compat\u00edvel com o Red Hat Enterprise Linux\u00ae. Est\u00e1 em intenso desenvolvimento pela comunidade.\" Assim como o Debian, o Rocky Linux \u00e9 Robusto, est\u00e1vel e leve, focado em produ\u00e7\u00e3o, corre\u00e7\u00f5es e atualiza\u00e7\u00f5es. A vers\u00e3o 8.x conta com suporte de atualiza\u00e7\u00e3o at\u00e9 o ano de 2027, o que por si s\u00f3 \u00e9 muito importante para administradores de sistema. P\u00e1gina Oficial do Rocky Linux Voc\u00ea pode fazer o Download da vers\u00e3o 8.x neste link Atualizado em 04 de Fevereiro de 2024","title":"In\u00edcio"},{"location":"#rocky-linux-como-ad-dc","text":"Nesta documenta\u00e7\u00e3o vamos abordar a instala\u00e7\u00e3o do SAMBA-AD-DC no sistema operacional Rocky Linux 8.x servindo como Active Directory e Controlador de Dom\u00ednio . Uma segunda m\u00e1quina, com o Rocky Linux 8.x, servindo como Replicador do AD agindo como uma m\u00e1quina de Backup do AD (sysvol). E por \u00faltimo, uma m\u00e1qina com Rocky Linux 8.x servindo como Membro e Servidor de Arquivos do AD .","title":"Rocky Linux como AD-DC"},{"location":"#por-que-o-rocky-linux","text":"\"O Rocky Linux \u00e9 um sistema operacional empresarial de c\u00f3digo aberto projetado para ser 100% bug-a-bug compat\u00edvel com o Red Hat Enterprise Linux\u00ae. Est\u00e1 em intenso desenvolvimento pela comunidade.\" Assim como o Debian, o Rocky Linux \u00e9 Robusto, est\u00e1vel e leve, focado em produ\u00e7\u00e3o, corre\u00e7\u00f5es e atualiza\u00e7\u00f5es. A vers\u00e3o 8.x conta com suporte de atualiza\u00e7\u00e3o at\u00e9 o ano de 2027, o que por si s\u00f3 \u00e9 muito importante para administradores de sistema. P\u00e1gina Oficial do Rocky Linux Voc\u00ea pode fazer o Download da vers\u00e3o 8.x neste link Atualizado em 04 de Fevereiro de 2024","title":"Por que o Rocky Linux?"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/","text":"PT-BR Samba AD-DC no Rocky Linux 8.7 M\u00e1quina 01 (DC1): Ser\u00e1 instalado o samba-ad-dc de modo que funcionar\u00e1 como um controlador de dom\u00ednio (DC1) principal M\u00e1quina 02 (Membro e Servidor de Arquivos): Ser\u00e1 instalado o samba-ad-dc de modo que funcionar\u00e1 como Membro e Servidor de arquivos do AD M\u00e1quina 03 (Replicador do DC1) - Controlador de dom\u00ednio 2 (DC2): Ser\u00e1 instalado o Samba-ad-dc de modo que funcionar\u00e1 como um replicador do controlador de dom\u00ednio. O controlador de dom\u00ednio principal far\u00e1 um backup do Sysvol para o controlador de dom\u00ednio 2 (DC2) ENG-USA Samba AD-DC on Rocky Linux 8.7 Machine 01 (DC1): Samba-ad-dc will be installed so that it will work with a primary domain controller (DC1) Machine 02 (Member and File Server): Samba-ad-dc will be installed so that it will work as an AD Member and File Server Machine 03 (DC1 Replicator) - Domain Controller 2 (DC2): Samba-ad-dc will be installed so that it will act as a replicator of the domain controller. The primary domain controller will make a Sysvol backup for domain controller 2 (DC2)","title":"Index"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#samba-ad-dc-no-rocky-linux-87","text":"","title":"Samba AD-DC no Rocky Linux 8.7"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#maquina-01-dc1","text":"Ser\u00e1 instalado o samba-ad-dc de modo que funcionar\u00e1 como um controlador de dom\u00ednio (DC1) principal","title":"M\u00e1quina 01 (DC1):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#maquina-02-membro-e-servidor-de-arquivos","text":"Ser\u00e1 instalado o samba-ad-dc de modo que funcionar\u00e1 como Membro e Servidor de arquivos do AD","title":"M\u00e1quina 02 (Membro e Servidor de Arquivos):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#maquina-03-replicador-do-dc1-controlador-de-dominio-2-dc2","text":"Ser\u00e1 instalado o Samba-ad-dc de modo que funcionar\u00e1 como um replicador do controlador de dom\u00ednio. O controlador de dom\u00ednio principal far\u00e1 um backup do Sysvol para o controlador de dom\u00ednio 2 (DC2) ENG-USA","title":"M\u00e1quina 03 (Replicador do DC1) - Controlador de dom\u00ednio 2 (DC2):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#samba-ad-dc-on-rocky-linux-87","text":"","title":"Samba AD-DC on Rocky Linux 8.7"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#machine-01-dc1","text":"Samba-ad-dc will be installed so that it will work with a primary domain controller (DC1)","title":"Machine 01 (DC1):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#machine-02-member-and-file-server","text":"Samba-ad-dc will be installed so that it will work as an AD Member and File Server","title":"Machine 02 (Member and File Server):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/#machine-03-dc1-replicator-domain-controller-2-dc2","text":"Samba-ad-dc will be installed so that it will act as a replicator of the domain controller. The primary domain controller will make a Sysvol backup for domain controller 2 (DC2)","title":"Machine 03 (DC1 Replicator) - Domain Controller 2 (DC2):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/","text":"Membro e Servidor de Arquivos do AD Update e Upgrade do sistema Update e Upgrade do sistema. Utilizar o comando: yum update -y && yum upgrade -y ======================================================================= Instalar Samba e pacotes necess\u00e1rios Instalar o samba e seus pacotes necess\u00e1rios para servidor de arquivos: dnf install samba samba-winbind samba-winbind-clients bind-utils Habilitar os servi\u00e7os smb nmb e winbind para iniciar junto ao boot do sistema: systemctl enable smb nmb winbind ======================================================================= Configurar e editar o arquivo /etc/hosts : Utilizar o editor de texto nano para editar o arquivo /etc/hosts nano /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 10.1.1.13 SRVFILE.seu.dominio SRVFILE ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Editar o arquivo /etc/hostname Com o editor de textos nano edite o arquivo /etc/hostname com o comando: nano /etc/hostname srvfile.seu.dominio Salvar o Arquivo Para salvar: control+o e para sair: control+x ======================================================================= Editar o arquivo /etc/nsswitch.conf Com o editor de textos nano edite o arquivo /etc/nsswitch.conf com o comando: nano /etc/nsswitch.conf Localize as Linhas e Mude a configura\u00e7\u00e3o De: passwd: sss files systemd Para: passwd: files winbind De: group: sss files systemd Para : group: files winbind Salve o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Configurar a Rede Configurar a rede e inserir dados do DNS do AD-DC ou seja, do seu controlador de dom\u00ednio DC1 . Execute o comando nmtui : nmtui Selecione Editar uma Conex\u00e3o Digite Enter Com a tela Tab selecione Editar Com as teclas de dire\u00e7\u00e3o (setas) mova-se at\u00e9 Servidores DNS e troque o IP para o IP de seu AD DC (controlador de dom\u00ednio) Ainda com as setas de dire\u00e7\u00e3o, selecione Dom\u00ednios de pesquisa e digite a tecla enter para adicionar o seu.dom\u00ednio . Ent\u00e3o, selecione OK com as setas de dire\u00e7\u00e3o e digite enter . Com a tecla Tab , selecione a op\u00e7\u00e3o: voltar e digite a tecla enter . Ent\u00e3o, com a tecla Tab , selecione a op\u00e7\u00e3o OK e digite enter Reiniciar o sistema : reboot ======================================================================= Arquivo user.map Editar o arquivo user.map no diret\u00f3rio /etc/samba com o conte\u00fado: nano /etc/samba/user.map !root = DOMINIO\\Administrator Salve o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Backup do arquivo original smb.conf Criar um backup do arquivo /etc/samba/smb.conf com o comando: mv /etc/samba/smb.conf /etc/samba/smb.conf.bkp ======================================================================= Criar um arquivo novo smb.conf Criar um arquivo smb.conf para funcionar como membro e servidor de arquivo de modelo ( rid ). Execute o comando abaixo e altere as linhas para seu cen\u00e1rio nano /etc/samba/smb.conf [global] bind interfaces only = Yes interfaces = lo ens18 # sua interface dedicated keytab file = /etc/krb5.keytab kerberos method = secrets and keytab log file = /var/log/samba/%m.log min domain uid = 0 realm = SEU.DOMINIODE username map = /etc/samba/user.map security = ADS template homedir = /home/%U template shell = /bin/bash winbind refresh tickets = Yes winbind use default domain = Yes workgroup = DOMINIO idmap config dominio : range = 10000-999999 idmap config dominio : backend = rid idmap config * : range = 3000-7999 idmap config * : backend = tdb map acl inherit = Yes vfs objects = acl_xattr Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Backup do arquivo krb5.conf Fazer uma c\u00f3pia do arquivo /etc/krb5.conf mv /etc/krb5.conf /etc/krb5.conf.bkp ======================================================================= Criar um novo arquivo krb5.conf Editar um novo arquivo krb5.conf e insira as linhas, alterando para seu cen\u00e1rio. nano /etc/krb5.conf [libdefaults] dns_lookup_realm = false dns_lookup_kdc = true default_realm = SEU.DOMINIO Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Comando testparm Verificar se existe algum erro de sintaxe com o comando: testparm Se n\u00e3o houver erros, executar o comando para recarregar o samba novamente smbcontrol all reload-config Desabilitar o SELinux: nano /etc/selinux/config Na linha SELINUX=enforcing trocar para SELINUX=disabled Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Ajustar o Firewall Ajustar o Firewall. Adicionar o servi\u00e7o do samba e recarregar o Firewall: firewall-cmd --add-service=samba --permanent firewall-cmd --reload Reiniciar o servidor : reboot ======================================================================= Juntar-se ao AD (join AD) Comando para juntar-se ao Dom\u00ednio Criado: net ads join -U administrator Enter administrator's password: senha do provisionamento Using short domain name -- DOMINIO Joined 'SRVFILE' to dns domain 'seu.dominio' ======================================================================= Verificar conex\u00e3o NETLOGON Verificar a conex\u00e3o Netlogon com o AD. Utilizar o comando: wbinfo --ping-dc O sa\u00edda do comando deve parecer com esta abaixo: checking the NETLOGON for domain[DOMINIO] dc connection to \"DC1.seu.dominio\" succeeded ======================================================================= Nslookup Verificar se o Servidor DC1 (seu controlador de dominio) volta resposta com o comando: nslookup SEU.DOMINIO. Altere os dados conforme seu cen\u00e1rio nslookup DC1.SEU.DOMINIO Um resultado parecido com esse deve aparecer na tela: nslookup DC1.seu.dominio Server: 10.1.1.31 Address: 10.1.1.31#53 Name: DC1.seu.dominio Address: 10.1.1.31 E tamb\u00e9m atrav\u00e9s do IP do seu Servidor AD : nslookup IP-serverad ======================================================================= Antes de prosseguir, conecte em seu DC1 e crie um grupo e um usu\u00e1rio . No DC1 execute o comando para criar o grupo por exemplo: samba-tool group add 'Linux Domain' E tamb\u00e9m adicione um usu\u00e1rio com o comando: samba-tool user add 'Linux Test' ======================================================================= GID do grupo a partir do DC2 Verificar se retorna o GID do Grupo criado. Utilize o comando abaixo: getent group \"DOMINIO\\\\Linux Domain\" linux domain:x:11115: ======================================================================= Garantir Privil\u00e9gios Garantir privil\u00e9gio de acesso. OBS: Altere o comando conforme seu cen\u00e1rio. Utilizar o comando: net rpc rights grant \"DOMINIO\\Domain Admins\" SeDiskOperatorPrivilege -U \"DOMINIO\\Administrator\" Enter DOMINIO\\Administrator password: senha CRIADA no provisionamento do DC1 # Caso tenha criado corretamente o sistema ir\u00e1 dar sucesso do comando Successfully granted rights. Chegando nesse ponto, est\u00e1 apto a iniciar a configura\u00e7\u00e3o da montagem de disco , o diret\u00f3rio escolhido para abrigar seus arquivos, bem como, ajustar as permiss\u00f5es de acesso para que seja poss\u00edvel fazer as altera\u00e7\u00f5es via RSAT do Windows com as devidas permiss\u00f5es. Por Exemplo : Se criou um disco e disponibilizou o diret\u00f3rio /srv/ad \u00e9 necess\u00e1rio indicar esse caminho em seu arquivo /etc/samba/smb.conf ou seja, ap\u00f3s a sess\u00e3o global , indicando o nome de seu compartilhamento do servidor de arquivos, caminho e ajustar as permiss\u00f5es de acesso seguindo o exemplo abaixo: OBS: Altere os dados conforme seu cen\u00e1rio nano /etc/samba/smb.conf [arqTeste] path = /srv/ad/ read only = no browseable = yes Salve o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Ajustando Permiss\u00f5es Ajustando as permiss\u00f5es para o Grupo no diret\u00f3rio criado. Utilize os comandos: chown root:\"Domain Admins\" /srv/ad chmod 0770 -R /srv/ad ======================================================================= Recarregar o samba Recarregar novamente o smbcontrol smbcontrol all reload-config ======================================================================= RSAT Windows Atrav\u00e9s do Windows, logue-se com a conta Administrator e atrav\u00e9s do RSAT inicie suas configura\u00e7\u00f5es desejadas. Espero poder ter ajudado. Muito Obrigado","title":"Membro e Servidor de Arquivos"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#membro-e-servidor-de-arquivos-do-ad","text":"","title":"Membro e Servidor de Arquivos do AD"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#update-e-upgrade-do-sistema","text":"Update e Upgrade do sistema. Utilizar o comando: yum update -y && yum upgrade -y =======================================================================","title":"Update e Upgrade do sistema"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#instalar-samba-e-pacotes-necessarios","text":"Instalar o samba e seus pacotes necess\u00e1rios para servidor de arquivos: dnf install samba samba-winbind samba-winbind-clients bind-utils Habilitar os servi\u00e7os smb nmb e winbind para iniciar junto ao boot do sistema: systemctl enable smb nmb winbind =======================================================================","title":"Instalar Samba e pacotes necess\u00e1rios"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#configurar-e-editar-o-arquivo-etchosts","text":"Utilizar o editor de texto nano para editar o arquivo /etc/hosts nano /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 10.1.1.13 SRVFILE.seu.dominio SRVFILE ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Configurar e editar o arquivo /etc/hosts:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#editar-o-arquivo-etchostname","text":"Com o editor de textos nano edite o arquivo /etc/hostname com o comando: nano /etc/hostname srvfile.seu.dominio Salvar o Arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Editar o arquivo /etc/hostname"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#editar-o-arquivo-etcnsswitchconf","text":"Com o editor de textos nano edite o arquivo /etc/nsswitch.conf com o comando: nano /etc/nsswitch.conf Localize as Linhas e Mude a configura\u00e7\u00e3o De: passwd: sss files systemd Para: passwd: files winbind De: group: sss files systemd Para : group: files winbind Salve o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Editar o arquivo /etc/nsswitch.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#configurar-a-rede","text":"Configurar a rede e inserir dados do DNS do AD-DC ou seja, do seu controlador de dom\u00ednio DC1 . Execute o comando nmtui : nmtui Selecione Editar uma Conex\u00e3o Digite Enter Com a tela Tab selecione Editar Com as teclas de dire\u00e7\u00e3o (setas) mova-se at\u00e9 Servidores DNS e troque o IP para o IP de seu AD DC (controlador de dom\u00ednio) Ainda com as setas de dire\u00e7\u00e3o, selecione Dom\u00ednios de pesquisa e digite a tecla enter para adicionar o seu.dom\u00ednio . Ent\u00e3o, selecione OK com as setas de dire\u00e7\u00e3o e digite enter . Com a tecla Tab , selecione a op\u00e7\u00e3o: voltar e digite a tecla enter . Ent\u00e3o, com a tecla Tab , selecione a op\u00e7\u00e3o OK e digite enter Reiniciar o sistema : reboot =======================================================================","title":"Configurar a Rede"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#arquivo-usermap","text":"Editar o arquivo user.map no diret\u00f3rio /etc/samba com o conte\u00fado: nano /etc/samba/user.map !root = DOMINIO\\Administrator Salve o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Arquivo user.map"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#backup-do-arquivo-original-smbconf","text":"Criar um backup do arquivo /etc/samba/smb.conf com o comando: mv /etc/samba/smb.conf /etc/samba/smb.conf.bkp =======================================================================","title":"Backup do arquivo original smb.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#criar-um-arquivo-novo-smbconf","text":"Criar um arquivo smb.conf para funcionar como membro e servidor de arquivo de modelo ( rid ). Execute o comando abaixo e altere as linhas para seu cen\u00e1rio nano /etc/samba/smb.conf [global] bind interfaces only = Yes interfaces = lo ens18 # sua interface dedicated keytab file = /etc/krb5.keytab kerberos method = secrets and keytab log file = /var/log/samba/%m.log min domain uid = 0 realm = SEU.DOMINIODE username map = /etc/samba/user.map security = ADS template homedir = /home/%U template shell = /bin/bash winbind refresh tickets = Yes winbind use default domain = Yes workgroup = DOMINIO idmap config dominio : range = 10000-999999 idmap config dominio : backend = rid idmap config * : range = 3000-7999 idmap config * : backend = tdb map acl inherit = Yes vfs objects = acl_xattr Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Criar um arquivo novo smb.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#backup-do-arquivo-krb5conf","text":"Fazer uma c\u00f3pia do arquivo /etc/krb5.conf mv /etc/krb5.conf /etc/krb5.conf.bkp =======================================================================","title":"Backup  do arquivo krb5.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#criar-um-novo-arquivo-krb5conf","text":"Editar um novo arquivo krb5.conf e insira as linhas, alterando para seu cen\u00e1rio. nano /etc/krb5.conf [libdefaults] dns_lookup_realm = false dns_lookup_kdc = true default_realm = SEU.DOMINIO Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Criar um novo arquivo krb5.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#comando-testparm","text":"Verificar se existe algum erro de sintaxe com o comando: testparm Se n\u00e3o houver erros, executar o comando para recarregar o samba novamente smbcontrol all reload-config Desabilitar o SELinux: nano /etc/selinux/config Na linha SELINUX=enforcing trocar para SELINUX=disabled Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Comando testparm"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#ajustar-o-firewall","text":"Ajustar o Firewall. Adicionar o servi\u00e7o do samba e recarregar o Firewall: firewall-cmd --add-service=samba --permanent firewall-cmd --reload Reiniciar o servidor : reboot =======================================================================","title":"Ajustar o Firewall"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#juntar-se-ao-ad-join-ad","text":"Comando para juntar-se ao Dom\u00ednio Criado: net ads join -U administrator Enter administrator's password: senha do provisionamento Using short domain name -- DOMINIO Joined 'SRVFILE' to dns domain 'seu.dominio'","title":"Juntar-se ao AD (join AD)"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#_1","text":"=======================================================================","title":""},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#verificar-conexao-netlogon","text":"Verificar a conex\u00e3o Netlogon com o AD. Utilizar o comando: wbinfo --ping-dc O sa\u00edda do comando deve parecer com esta abaixo: checking the NETLOGON for domain[DOMINIO] dc connection to \"DC1.seu.dominio\" succeeded =======================================================================","title":"Verificar conex\u00e3o NETLOGON"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#nslookup","text":"Verificar se o Servidor DC1 (seu controlador de dominio) volta resposta com o comando: nslookup SEU.DOMINIO. Altere os dados conforme seu cen\u00e1rio nslookup DC1.SEU.DOMINIO Um resultado parecido com esse deve aparecer na tela: nslookup DC1.seu.dominio Server: 10.1.1.31 Address: 10.1.1.31#53 Name: DC1.seu.dominio Address: 10.1.1.31 E tamb\u00e9m atrav\u00e9s do IP do seu Servidor AD : nslookup IP-serverad ======================================================================= Antes de prosseguir, conecte em seu DC1 e crie um grupo e um usu\u00e1rio . No DC1 execute o comando para criar o grupo por exemplo: samba-tool group add 'Linux Domain' E tamb\u00e9m adicione um usu\u00e1rio com o comando: samba-tool user add 'Linux Test' =======================================================================","title":"Nslookup"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#gid-do-grupo-a-partir-do-dc2","text":"Verificar se retorna o GID do Grupo criado. Utilize o comando abaixo: getent group \"DOMINIO\\\\Linux Domain\" linux domain:x:11115: =======================================================================","title":"GID do grupo a partir do DC2"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#garantir-privilegios","text":"Garantir privil\u00e9gio de acesso. OBS: Altere o comando conforme seu cen\u00e1rio. Utilizar o comando: net rpc rights grant \"DOMINIO\\Domain Admins\" SeDiskOperatorPrivilege -U \"DOMINIO\\Administrator\" Enter DOMINIO\\Administrator password: senha CRIADA no provisionamento do DC1 # Caso tenha criado corretamente o sistema ir\u00e1 dar sucesso do comando Successfully granted rights. Chegando nesse ponto, est\u00e1 apto a iniciar a configura\u00e7\u00e3o da montagem de disco , o diret\u00f3rio escolhido para abrigar seus arquivos, bem como, ajustar as permiss\u00f5es de acesso para que seja poss\u00edvel fazer as altera\u00e7\u00f5es via RSAT do Windows com as devidas permiss\u00f5es. Por Exemplo : Se criou um disco e disponibilizou o diret\u00f3rio /srv/ad \u00e9 necess\u00e1rio indicar esse caminho em seu arquivo /etc/samba/smb.conf ou seja, ap\u00f3s a sess\u00e3o global , indicando o nome de seu compartilhamento do servidor de arquivos, caminho e ajustar as permiss\u00f5es de acesso seguindo o exemplo abaixo: OBS: Altere os dados conforme seu cen\u00e1rio nano /etc/samba/smb.conf [arqTeste] path = /srv/ad/ read only = no browseable = yes Salve o arquivo Para salvar: control+o e para sair: control+x","title":"Garantir Privil\u00e9gios"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#_2","text":"=======================================================================","title":""},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#ajustando-permissoes","text":"Ajustando as permiss\u00f5es para o Grupo no diret\u00f3rio criado. Utilize os comandos: chown root:\"Domain Admins\" /srv/ad chmod 0770 -R /srv/ad =======================================================================","title":"Ajustando Permiss\u00f5es"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#recarregar-o-samba","text":"Recarregar novamente o smbcontrol smbcontrol all reload-config =======================================================================","title":"Recarregar o samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/member-file-server/#rsat-windows","text":"Atrav\u00e9s do Windows, logue-se com a conta Administrator e atrav\u00e9s do RSAT inicie suas configura\u00e7\u00f5es desejadas. Espero poder ter ajudado. Muito Obrigado","title":"RSAT Windows"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/","text":"Configurar Samba AD-DC (DC1) Controlador de Dom\u00ednio ======================================================================= Executar um update e upgrade do sistema: yum update -y && yum upgrade -y Instalar o editor de texto nano : dnf install nano ======================================================================= Configurar a Rede Verificar sua configura\u00e7\u00e3o de rede e DNS , bem como nome de dom\u00ednio . Uma das formas: Abra um terminal e execute o comando nmtui : nmtui Selecione Editar uma conex\u00e3o . Ent\u00e3o a op\u00e7\u00e3o Editar . Verificar ou alterar seu endere\u00e7o ip , m\u00e1scara de sub-rede e seu Gateway . Na op\u00e7\u00e3o Servidor DNS : inserir o DNS desejado. N\u00e3o esquecer de inserir em Dom\u00ednios de pesquisa: seu.dom\u00ednio . V\u00e1 at\u00e9 o fim e selecione OK para salvar. Selecione Voltar e ent\u00e3o no menu: selecionar a op\u00e7\u00e3o: Definir nome de m\u00e1quina do sistema : dc1.seu.dominio . Agora selecione a op\u00e7\u00e3o: OK para salvar. Novamente selecione OK . Deve retornar para o terminal. ======================================================================= Editar o arquivo /etc/host : nano /etc/hosts Inserir os dados referentes ao seu servidor: 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 # inserir os dados de seu server 10.1.1.31 dc1 dc1.seu.dominio Onde: 10.1.1.31 = IP de seu pr\u00f3prio AD-DC (controlador de dom\u00ednio) dc1 = nome simplificado do seu host de seu controlador de dom\u00ednio dc1.seu.dom\u00ednio = nome do host + seu.dom\u00ednio ======================================================================= Veririficar processo do Samba Verificar se existe algum processo do samba rodando: # ps ax | egrep \"samba|smbd|nmbd|winbindd\" Remover qualquer config file que houver, checando com o comando: # smbd -b | grep \"CONFIGFILE\" CONFIGFILE: /usr/local/samba/etc/samba/smb.conf Remover todos arquivos de data base que houver. Como: .tdb e .ldb: # smbd -b | egrep \"LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR\" LOCKDIR: /usr/local/samba/var/lock/ STATEDIR: /usr/local/samba/var/locks/ CACHEDIR: /usr/local/samba/var/cache/ PRIVATE_DIR: /usr/local/samba/private/ ======================================================================= Remover o arquivo /etc/krb5.conf Remover o arquivo /etc/krb5.conf se houver, com o comando: rm /etc/krb5.conf ======================================================================= Instalar Plugins Instalar plugins e habilitar o reposit\u00f3rio PowerTools com os comandos abaixo: dnf install dnf-plugins-core dnf install epel-release dnf config-manager --set-enabled powertools dnf update Checar os reposit\u00f3rios adicionados com o comando: dnf repolist O resultado deve ser algo como: id do repo nome do repo appstream Rocky Linux 8 - AppStream baseos Rocky Linux 8 - BaseOS devel Rocky Linux 8 - Devel WARNING! FOR BUILDROOT AND KOJI USE - epel Extra Packages for Enterprise Linux 8 - x86_64 - extras Rocky Linux 8 - Extras - powertools Rocky Linux 8 - PowerTools ======================================================================= Setar a hora local (ntp): Listando as op\u00e7\u00f5es de hora local. timedatectl list-timezones Para setar o timezone desejado, usar o comando: timedatectl set-timezone America/Sao_Paulo Verificando o timezone setado: timedatectl O resultado deve parecer como abaixo: Local time: qua 2023-04-12 09:04:22 -03 Universal time: qua 2023-04-12 12:04:22 UTC RTC time: qua 2023-04-12 12:00:16 Time zone: America/Sao_Paulo (-03, -0300) System clock synchronized: yes NTP service: active RTC in local TZ: no ======================================================================= Instalar as depend\u00eancias dos pacotes. Instalar as depend\u00eancias dos pacotes. Criar um arquivo do tipo script execut\u00e1vel e inserir os comandos: nano depende.sh Inserir as linhas abaixo para o seu arquivo: Atualizado em 03/02/2024 set -xueo pipefail dnf install -y epel-release dnf config-manager --enable epel dnf install -y yum-utils dnf config-manager --set-enabled powertools dnf update -y yum install -y \\ gcc.x86_64 \\ tar \\ python36.x86_64 \\ wget \\ nano \\ perl.x86_64 perl-Parse-Yapp.noarch \\ libacl.x86_64 \\ nfs4-acl-tools.x86_64 \\ gnutls-devel.x86_64 \\ zlib.x86_64 \\ krb5-devel.x86_64 \\ krb5-server \\ libblkid.x86_64 \\ dbus-devel.x86_64 \\ jansson-devel.x86_64 \\ readline.x86_64 \\ bsdtar.x86_64 \\ docbook-dtds.noarch \\ pam-devel \\ cups \\ python3-markdown \\ patchutils.x86_64 \\ gpgme-devel \\ flex \\ python3-iso8601.noarch \\ python3-cryptography.x86_64 \\ python36-devel \\ lmdb.x86_64 \\ libarchive-devel \\ libacl-devel \\ openldap-devel \\ python3-dns \\ perl-Convert-ASN1.noarch \\ rpcgen.x86_64 \\ perl-App-cpanminus \\ popt-devel.x86_64 \\ zlib-devel.x86_64 \\ lmdb-devel.x86_64 \\ bison-devel.x86_64 \\ libtasn1-tools \\ bison \\ perl-JSON \\ yum autoremove -y yum clean all Salvar o arquivo Para salvar: control+o e para sair: control+x Transformar o arquivo em um execut\u00e1vel com o comando: chmod +x depende.sh Executar o aquivo com o comando: ./depende.sh ======================================================================= Fazer download do Samba Fazer download do samba ou da vers\u00e3o desejada, utilizando o comando: wget https://download.samba.org/pub/samba/stable/samba-4.18.0.tar.gz Descompactar o arquivo baixado: tar -zxvf samba-nome-arquivo Mudar para o diret\u00f3rio onde foi descompactado: cd samba-nome-arquivo/ ======================================================================= Compilar o Samba Compilar o samba e fazer o arquivo de configura\u00e7\u00e3o (smb.conf) ficar em: /etc/samba/smb.conf com o comando: ./configure --sysconfdir=/etc/samba/ Aguarde o processo finalizar. ======================================================================= Comandos make e make install E ent\u00e3o, execute os comandos make e make install : make && make install Mude para o diret\u00f3rio /root e edite o arquivo .bash_profile com os comandos: cd /root nano .bash_profile Inserir a linha: # User specific environment and startup programs PATH=$PATH:$HOME/bin # ESTA LINHA PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH export PATH Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Servi\u00e7o Systemd Samba Criar um arquivo de servi\u00e7o systemd do samba Executar os comandos: systemctl mask smbd nmbd winbind systemctl disable smbd nmbd winbind Criar o arquivo em: /etc/systemd/system/samba-ad-dc.service nano /etc/systemd/system/samba-ad-dc.service Com as seguintes linhas (copie e cole para seu arquivo): [Unit] Description=Samba Active Directory Domain Controller After=network.target remote-fs.target nss-lookup.target [Service] Type=forking ExecStart=/usr/local/samba/sbin/samba -D PIDFile=/usr/local/samba/var/run/samba.pid ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target Salvar o arquivo Para salvar: control+o e para sair: control+x Recarregar systemd com o comando: systemctl daemon-reload Habilitar o samba-ad-dc para iniciar no boot do sistema: systemctl enable samba-ad-dc ======================================================================= Verificar dispositivo de rede Verificar em qual dispositivo de rede est\u00e1 sua conex\u00e3o. No terminal execute o comando: ip a O resultado deve ser parecido com isso: 2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether de:1e:07:63:42:51 brd ff:ff:ff:ff:ff:ff altname enp0s18 inet 10.1.1.31/24 brd 10.1.1.255 scope global noprefixroute ens18 OBS : o ens18 neste caso \u00e9 seu dispositivo ======================================================================= Desabilitar SELinux Editar o arquivo /etc/selinux/config : nano /etc/selinux/config Encontre a linha e mude para disabled como mostra abaixo: # disabled - No SELinux policy is loaded. SELINUX=disabled Salve o arquivo: Para salvar: control+o e para sair control+x ====================================================================== Reboot o sistema Fazer um reboot do sistema com o comando: reboot ======================================================================= Provisionar o Samba Provisionando o Samba. No terminal execute o comando: Obs: n\u00e3o esque\u00e7a de alterar para o seu dispositivo de rede samba-tool domain provision --use-rfc2307 --interactive --option=\"interfaces= lo ens18\" --option=\"bind interfaces only=yes\" Responda as quest\u00f5es referente ao seu cen\u00e1rio : Realm: SEU.Dominio Domain [AD]: Dom\u00ednio Server Role (dc, member, standalone) [dc]: dc DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) SAMBA_INTERNAL]: SAMBA_INTERNAL DNS forwarder IP address (write 'none' to disable forwarding) [SEU_IP_DNS]:IP DNS Administrator password: escolher uma senha Retype password: repetir a mesma senha OBS: Guarde a senha de provisionamento ======================================================================= Configurar Kerberos: Execute o comando abaixo: cp /usr/local/samba/private/krb5.conf /etc/krb5.conf Restart o servi\u00e7o do samba-ad com o comando: systemctl restart samba-ad-dc Para parar servi\u00e7o fazer o comando: systemctl stop samba-ad-dc Se necessitar desabilitar o servi\u00e7o, utilizar o comando: systemctl disable samba-ad-dc ======================================================================= Verificar a vers\u00e3o do samba smbclient --version ======================================================================= Testar o samba smbclient -L localhost -U% ======================================================================= Verificar o DNS (_ldap) host -t SRV _ldap._tcp.seu.dominio ======================================================================= Verificar _kerberos host -t SRV _kerberos._udp.seu.dominio. ======================================================================= A Grava\u00e7\u00e3o A host -t A seu.dominio ======================================================================= Verificando o Kerberos kinit Administrator Password for Administrator@SEU.DOMINIO: Warning: Your password will expire in 41 days on Tue 22 Sep 2020 03:41:22 PM IST ======================================================================= Listar o cache dos tickets Listar o cache dos tickets com o comando: klist A resposta deve ser parecida com essa: Valid starting Expires Service principal 13/04/2023 13:54:57 13/04/2023 23:54:57 krbtgt/SEU.DOMINIO@SEU.DOMINIO renew until 14/04/2023 13:54:50 ======================================================================= Configurar o Firewall Adicionar servi\u00e7os: firewall-cmd --add-service={dns,ldap,ldaps,kerberos} Abrir portas TCP : firewall-cmd --permanent --zone=public --add-port={53/tcp,135/tcp,139/tcp,389/tcp,445/tcp,465/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp}; Abrir portas UDP : firewall-cmd --permanent --zone=public --add-port={88/udp,123/udp,137/udp,138/udp,389/udp,464/udp}; Recarregar o Firewall: firewall-cmd --reload ======================================================================= Replica\u00e7\u00e3o do SysVol Replica\u00e7\u00e3o do SysVol (backup do AD) para um Segundo Controlador de Dom\u00ednio: DC2 Gerar uma chave SSH-Keygen no primeiro Controlador de Dom\u00ednio: DC1 com o comando: ssh-keygen -t rsa Algumas perguntas ser\u00e3o feitas: Onde salvar o arquvo de chave, que neste caso: (/root/.ssh/id_rsa) teclar enter Entre com uma senha (ou apenas digite enter para ficar sem senha), teclar enter Entre com a senha novamente: teclar enter A sa\u00edda ser\u00e1 algo como: Your identification has been saved in /root/.ssh/id_rsa. Your public key has been saved in /root/.ssh/id_rsa.pub. Quando a chave for criada, copiar para o servidor que ser\u00e1 o segundo DC2 com o comando: ssh-copy-id user-dc2@IP-Seu-DC2 Agora pode-se conectar atrav\u00e9s do ssh sem requerer senha de acesso. Conecte-se via ssh em seu DC2 e mude as permiss\u00f5es de acesso para que o usu\u00e1rio do dc2 possa escrever no diret\u00f3rio, com o comando: chown root.user-dc2 -R /usr/local/samba/var/locks/sysvol/ ====================================================================== Backup arquivo idmap.ldb Voltando ao seu DC1 Para fazer a replica\u00e7\u00e3o do sysvol do DC1 para o DC2 , o dc2 deve ter o mesmo mapa ID para os usu\u00e1rios e grupos. Execute o comando abaixo para fazer um backup do arquivo idmap.ldb: tdbbackup -s.bak /usr/local/samba/private/idmap.ldb idmap.bak Com o arquivo de backup gerado: idmap.bak copie o mesmo para o caminho de seu DC2 com o comando: scp /usr/local/samba/private/idmap.bak root@IP-SEU-DC2:/usr/local/samba/private/ Conecte-se ao DC2 para renomear o arquivo de backup enviado atrav\u00e9s do DC1 (idmap.bak), usando o comando: mv /usr/local/samba/private/idmap.bak idmap.ldb ====================================================================== NTACL (samba-tool) Logo ap\u00f3s executar o comando abaixo nos dois DCs samba-tool ntacl sysvolreset ======================================================================= Sysvol Backup (DC1 para DC2) Executando um backup do DC1 para o DC2 . Para testar, execute o comando utilizando a op\u00e7\u00e3o --dry-run para um teste sem altera\u00e7\u00e3o: rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol user-dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/ O comando rsync far\u00e1 uma copia do sysvol de seu DC1 ( parte1 ) para o sysvol de seu DC2 ( parte2 ): Parte 1: rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol/ Parte 2: user-dc2@ IP-DC2:/usr/local/samba/var/locks/sysvol/ O resultado deve ser algo parecido com: building file list ... 12 files to consider ./ seu.dominio/ seu.dominio/Policies/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/USER/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/GPT.INI seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/MACHINE/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/USER/ seu.dominio/scripts/ Number of files: 12 (reg: 2, dir: 10) Number of created files: 9 (reg: 2, dir: 7) Number of deleted files: 0 Number of regular files transferred: 2 Total file size: 40 bytes Total transferred file size: 40 bytes Literal data: 0 bytes Matched data: 0 bytes File list size: 0 File list generation time: 0.038 seconds File list transfer time: 0.000 seconds Total bytes sent: 2,011 Total bytes received: 51 sent 2,011 bytes received 51 bytes 1,374.67 bytes/sec total size is 40 speedup is 0.02 **(DRY RUN)** Com o resultado positivo, utilize o comando sem a op\u00e7\u00e3o --dry-run : rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/ Para automatizar o processo, inserir o comando no crontab . Para aprender mais sobre o crontab clique aqui Script no crontab Adicionar um script no crontab para o backup ser autom\u00e1tico,com o comando: crontab -e E insira a linha: 0 12 * * 1-5 root rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/","title":"Instalar Samba DC1"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#configurar-samba-ad-dc-dc1-controlador-de-dominio","text":"======================================================================= Executar um update e upgrade do sistema: yum update -y && yum upgrade -y Instalar o editor de texto nano : dnf install nano =======================================================================","title":"Configurar Samba AD-DC (DC1) Controlador de Dom\u00ednio"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#configurar-a-rede","text":"Verificar sua configura\u00e7\u00e3o de rede e DNS , bem como nome de dom\u00ednio . Uma das formas: Abra um terminal e execute o comando nmtui : nmtui Selecione Editar uma conex\u00e3o . Ent\u00e3o a op\u00e7\u00e3o Editar . Verificar ou alterar seu endere\u00e7o ip , m\u00e1scara de sub-rede e seu Gateway . Na op\u00e7\u00e3o Servidor DNS : inserir o DNS desejado. N\u00e3o esquecer de inserir em Dom\u00ednios de pesquisa: seu.dom\u00ednio . V\u00e1 at\u00e9 o fim e selecione OK para salvar. Selecione Voltar e ent\u00e3o no menu: selecionar a op\u00e7\u00e3o: Definir nome de m\u00e1quina do sistema : dc1.seu.dominio . Agora selecione a op\u00e7\u00e3o: OK para salvar. Novamente selecione OK . Deve retornar para o terminal. =======================================================================","title":"Configurar a Rede"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#editar-o-arquivo-etchost","text":"nano /etc/hosts Inserir os dados referentes ao seu servidor: 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 # inserir os dados de seu server 10.1.1.31 dc1 dc1.seu.dominio Onde: 10.1.1.31 = IP de seu pr\u00f3prio AD-DC (controlador de dom\u00ednio) dc1 = nome simplificado do seu host de seu controlador de dom\u00ednio dc1.seu.dom\u00ednio = nome do host + seu.dom\u00ednio =======================================================================","title":"Editar o arquivo /etc/host:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#veririficar-processo-do-samba","text":"Verificar se existe algum processo do samba rodando: # ps ax | egrep \"samba|smbd|nmbd|winbindd\" Remover qualquer config file que houver, checando com o comando: # smbd -b | grep \"CONFIGFILE\" CONFIGFILE: /usr/local/samba/etc/samba/smb.conf Remover todos arquivos de data base que houver. Como: .tdb e .ldb: # smbd -b | egrep \"LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR\" LOCKDIR: /usr/local/samba/var/lock/ STATEDIR: /usr/local/samba/var/locks/ CACHEDIR: /usr/local/samba/var/cache/ PRIVATE_DIR: /usr/local/samba/private/ =======================================================================","title":"Veririficar processo do Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#remover-o-arquivo-etckrb5conf","text":"Remover o arquivo /etc/krb5.conf se houver, com o comando: rm /etc/krb5.conf =======================================================================","title":"Remover o arquivo /etc/krb5.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#instalar-plugins","text":"Instalar plugins e habilitar o reposit\u00f3rio PowerTools com os comandos abaixo: dnf install dnf-plugins-core dnf install epel-release dnf config-manager --set-enabled powertools dnf update Checar os reposit\u00f3rios adicionados com o comando: dnf repolist O resultado deve ser algo como: id do repo nome do repo appstream Rocky Linux 8 - AppStream baseos Rocky Linux 8 - BaseOS devel Rocky Linux 8 - Devel WARNING! FOR BUILDROOT AND KOJI USE - epel Extra Packages for Enterprise Linux 8 - x86_64 - extras Rocky Linux 8 - Extras - powertools Rocky Linux 8 - PowerTools =======================================================================","title":"Instalar Plugins"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#setar-a-hora-local-ntp","text":"Listando as op\u00e7\u00f5es de hora local. timedatectl list-timezones Para setar o timezone desejado, usar o comando: timedatectl set-timezone America/Sao_Paulo Verificando o timezone setado: timedatectl O resultado deve parecer como abaixo: Local time: qua 2023-04-12 09:04:22 -03 Universal time: qua 2023-04-12 12:04:22 UTC RTC time: qua 2023-04-12 12:00:16 Time zone: America/Sao_Paulo (-03, -0300) System clock synchronized: yes NTP service: active RTC in local TZ: no =======================================================================","title":"Setar a hora local (ntp):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#instalar-as-dependencias-dos-pacotes","text":"Instalar as depend\u00eancias dos pacotes. Criar um arquivo do tipo script execut\u00e1vel e inserir os comandos: nano depende.sh Inserir as linhas abaixo para o seu arquivo: Atualizado em 03/02/2024 set -xueo pipefail dnf install -y epel-release dnf config-manager --enable epel dnf install -y yum-utils dnf config-manager --set-enabled powertools dnf update -y yum install -y \\ gcc.x86_64 \\ tar \\ python36.x86_64 \\ wget \\ nano \\ perl.x86_64 perl-Parse-Yapp.noarch \\ libacl.x86_64 \\ nfs4-acl-tools.x86_64 \\ gnutls-devel.x86_64 \\ zlib.x86_64 \\ krb5-devel.x86_64 \\ krb5-server \\ libblkid.x86_64 \\ dbus-devel.x86_64 \\ jansson-devel.x86_64 \\ readline.x86_64 \\ bsdtar.x86_64 \\ docbook-dtds.noarch \\ pam-devel \\ cups \\ python3-markdown \\ patchutils.x86_64 \\ gpgme-devel \\ flex \\ python3-iso8601.noarch \\ python3-cryptography.x86_64 \\ python36-devel \\ lmdb.x86_64 \\ libarchive-devel \\ libacl-devel \\ openldap-devel \\ python3-dns \\ perl-Convert-ASN1.noarch \\ rpcgen.x86_64 \\ perl-App-cpanminus \\ popt-devel.x86_64 \\ zlib-devel.x86_64 \\ lmdb-devel.x86_64 \\ bison-devel.x86_64 \\ libtasn1-tools \\ bison \\ perl-JSON \\ yum autoremove -y yum clean all Salvar o arquivo Para salvar: control+o e para sair: control+x Transformar o arquivo em um execut\u00e1vel com o comando: chmod +x depende.sh Executar o aquivo com o comando: ./depende.sh =======================================================================","title":"Instalar as depend\u00eancias dos pacotes."},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#fazer-download-do-samba","text":"Fazer download do samba ou da vers\u00e3o desejada, utilizando o comando: wget https://download.samba.org/pub/samba/stable/samba-4.18.0.tar.gz Descompactar o arquivo baixado: tar -zxvf samba-nome-arquivo Mudar para o diret\u00f3rio onde foi descompactado: cd samba-nome-arquivo/ =======================================================================","title":"Fazer download do Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#compilar-o-samba","text":"Compilar o samba e fazer o arquivo de configura\u00e7\u00e3o (smb.conf) ficar em: /etc/samba/smb.conf com o comando: ./configure --sysconfdir=/etc/samba/ Aguarde o processo finalizar. =======================================================================","title":"Compilar o Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#comandos-make-e-make-install","text":"E ent\u00e3o, execute os comandos make e make install : make && make install Mude para o diret\u00f3rio /root e edite o arquivo .bash_profile com os comandos: cd /root nano .bash_profile Inserir a linha: # User specific environment and startup programs PATH=$PATH:$HOME/bin # ESTA LINHA PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH export PATH Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Comandos make e make install"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#servico-systemd-samba","text":"Criar um arquivo de servi\u00e7o systemd do samba Executar os comandos: systemctl mask smbd nmbd winbind systemctl disable smbd nmbd winbind Criar o arquivo em: /etc/systemd/system/samba-ad-dc.service nano /etc/systemd/system/samba-ad-dc.service Com as seguintes linhas (copie e cole para seu arquivo): [Unit] Description=Samba Active Directory Domain Controller After=network.target remote-fs.target nss-lookup.target [Service] Type=forking ExecStart=/usr/local/samba/sbin/samba -D PIDFile=/usr/local/samba/var/run/samba.pid ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target Salvar o arquivo Para salvar: control+o e para sair: control+x Recarregar systemd com o comando: systemctl daemon-reload Habilitar o samba-ad-dc para iniciar no boot do sistema: systemctl enable samba-ad-dc =======================================================================","title":"Servi\u00e7o Systemd Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#verificar-dispositivo-de-rede","text":"Verificar em qual dispositivo de rede est\u00e1 sua conex\u00e3o. No terminal execute o comando: ip a O resultado deve ser parecido com isso: 2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether de:1e:07:63:42:51 brd ff:ff:ff:ff:ff:ff altname enp0s18 inet 10.1.1.31/24 brd 10.1.1.255 scope global noprefixroute ens18 OBS : o ens18 neste caso \u00e9 seu dispositivo =======================================================================","title":"Verificar dispositivo de rede"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#desabilitar-selinux","text":"Editar o arquivo /etc/selinux/config : nano /etc/selinux/config Encontre a linha e mude para disabled como mostra abaixo: # disabled - No SELinux policy is loaded. SELINUX=disabled Salve o arquivo: Para salvar: control+o e para sair control+x ======================================================================","title":"Desabilitar SELinux"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#reboot-o-sistema","text":"Fazer um reboot do sistema com o comando: reboot =======================================================================","title":"Reboot o sistema"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#provisionar-o-samba","text":"Provisionando o Samba. No terminal execute o comando: Obs: n\u00e3o esque\u00e7a de alterar para o seu dispositivo de rede samba-tool domain provision --use-rfc2307 --interactive --option=\"interfaces= lo ens18\" --option=\"bind interfaces only=yes\" Responda as quest\u00f5es referente ao seu cen\u00e1rio : Realm: SEU.Dominio Domain [AD]: Dom\u00ednio Server Role (dc, member, standalone) [dc]: dc DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) SAMBA_INTERNAL]: SAMBA_INTERNAL DNS forwarder IP address (write 'none' to disable forwarding) [SEU_IP_DNS]:IP DNS Administrator password: escolher uma senha Retype password: repetir a mesma senha OBS: Guarde a senha de provisionamento =======================================================================","title":"Provisionar o Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#configurar-kerberos","text":"Execute o comando abaixo: cp /usr/local/samba/private/krb5.conf /etc/krb5.conf Restart o servi\u00e7o do samba-ad com o comando: systemctl restart samba-ad-dc Para parar servi\u00e7o fazer o comando: systemctl stop samba-ad-dc Se necessitar desabilitar o servi\u00e7o, utilizar o comando: systemctl disable samba-ad-dc =======================================================================","title":"Configurar Kerberos:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#verificar-a-versao-do-samba","text":"smbclient --version =======================================================================","title":"Verificar a vers\u00e3o do samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#testar-o-samba","text":"smbclient -L localhost -U% =======================================================================","title":"Testar o samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#verificar-o-dns-_ldap","text":"host -t SRV _ldap._tcp.seu.dominio =======================================================================","title":"Verificar o DNS (_ldap)"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#verificar-_kerberos","text":"host -t SRV _kerberos._udp.seu.dominio. =======================================================================","title":"Verificar _kerberos"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#a-gravacao-a","text":"host -t A seu.dominio =======================================================================","title":"A Grava\u00e7\u00e3o A"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#verificando-o-kerberos","text":"kinit Administrator Password for Administrator@SEU.DOMINIO: Warning: Your password will expire in 41 days on Tue 22 Sep 2020 03:41:22 PM IST =======================================================================","title":"Verificando o Kerberos"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#listar-o-cache-dos-tickets","text":"Listar o cache dos tickets com o comando: klist A resposta deve ser parecida com essa: Valid starting Expires Service principal 13/04/2023 13:54:57 13/04/2023 23:54:57 krbtgt/SEU.DOMINIO@SEU.DOMINIO renew until 14/04/2023 13:54:50 =======================================================================","title":"Listar o cache dos tickets"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#configurar-o-firewall","text":"Adicionar servi\u00e7os: firewall-cmd --add-service={dns,ldap,ldaps,kerberos} Abrir portas TCP : firewall-cmd --permanent --zone=public --add-port={53/tcp,135/tcp,139/tcp,389/tcp,445/tcp,465/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp}; Abrir portas UDP : firewall-cmd --permanent --zone=public --add-port={88/udp,123/udp,137/udp,138/udp,389/udp,464/udp}; Recarregar o Firewall: firewall-cmd --reload =======================================================================","title":"Configurar o Firewall"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#replicacao-do-sysvol","text":"Replica\u00e7\u00e3o do SysVol (backup do AD) para um Segundo Controlador de Dom\u00ednio: DC2 Gerar uma chave SSH-Keygen no primeiro Controlador de Dom\u00ednio: DC1 com o comando: ssh-keygen -t rsa Algumas perguntas ser\u00e3o feitas: Onde salvar o arquvo de chave, que neste caso: (/root/.ssh/id_rsa) teclar enter Entre com uma senha (ou apenas digite enter para ficar sem senha), teclar enter Entre com a senha novamente: teclar enter A sa\u00edda ser\u00e1 algo como: Your identification has been saved in /root/.ssh/id_rsa. Your public key has been saved in /root/.ssh/id_rsa.pub. Quando a chave for criada, copiar para o servidor que ser\u00e1 o segundo DC2 com o comando: ssh-copy-id user-dc2@IP-Seu-DC2 Agora pode-se conectar atrav\u00e9s do ssh sem requerer senha de acesso. Conecte-se via ssh em seu DC2 e mude as permiss\u00f5es de acesso para que o usu\u00e1rio do dc2 possa escrever no diret\u00f3rio, com o comando: chown root.user-dc2 -R /usr/local/samba/var/locks/sysvol/ ======================================================================","title":"Replica\u00e7\u00e3o do SysVol"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#backup-arquivo-idmapldb","text":"Voltando ao seu DC1 Para fazer a replica\u00e7\u00e3o do sysvol do DC1 para o DC2 , o dc2 deve ter o mesmo mapa ID para os usu\u00e1rios e grupos. Execute o comando abaixo para fazer um backup do arquivo idmap.ldb: tdbbackup -s.bak /usr/local/samba/private/idmap.ldb idmap.bak Com o arquivo de backup gerado: idmap.bak copie o mesmo para o caminho de seu DC2 com o comando: scp /usr/local/samba/private/idmap.bak root@IP-SEU-DC2:/usr/local/samba/private/ Conecte-se ao DC2 para renomear o arquivo de backup enviado atrav\u00e9s do DC1 (idmap.bak), usando o comando: mv /usr/local/samba/private/idmap.bak idmap.ldb ======================================================================","title":"Backup arquivo idmap.ldb"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#ntacl-samba-tool","text":"Logo ap\u00f3s executar o comando abaixo nos dois DCs samba-tool ntacl sysvolreset =======================================================================","title":"NTACL (samba-tool)"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#sysvol-backup-dc1-para-dc2","text":"Executando um backup do DC1 para o DC2 . Para testar, execute o comando utilizando a op\u00e7\u00e3o --dry-run para um teste sem altera\u00e7\u00e3o: rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol user-dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/ O comando rsync far\u00e1 uma copia do sysvol de seu DC1 ( parte1 ) para o sysvol de seu DC2 ( parte2 ): Parte 1: rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol/ Parte 2: user-dc2@ IP-DC2:/usr/local/samba/var/locks/sysvol/ O resultado deve ser algo parecido com: building file list ... 12 files to consider ./ seu.dominio/ seu.dominio/Policies/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/ seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/USER/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/GPT.INI seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/MACHINE/ seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/USER/ seu.dominio/scripts/ Number of files: 12 (reg: 2, dir: 10) Number of created files: 9 (reg: 2, dir: 7) Number of deleted files: 0 Number of regular files transferred: 2 Total file size: 40 bytes Total transferred file size: 40 bytes Literal data: 0 bytes Matched data: 0 bytes File list size: 0 File list generation time: 0.038 seconds File list transfer time: 0.000 seconds Total bytes sent: 2,011 Total bytes received: 51 sent 2,011 bytes received 51 bytes 1,374.67 bytes/sec total size is 40 speedup is 0.02 **(DRY RUN)** Com o resultado positivo, utilize o comando sem a op\u00e7\u00e3o --dry-run : rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/ Para automatizar o processo, inserir o comando no crontab . Para aprender mais sobre o crontab clique aqui","title":"Sysvol Backup (DC1 para DC2)"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad-dc1/#script-no-crontab","text":"Adicionar um script no crontab para o backup ser autom\u00e1tico,com o comando: crontab -e E insira a linha: 0 12 * * 1-5 root rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/","title":"Script no crontab"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/","text":"Configurar Samba AD-DC (DC2) Replicador Configurar o Rocky Linux para agir como um replicador do DC1 (backup) ======================================================================= Update e upgrade do sistema: yum update -y && yum upgrade -y Instalar o editor de texto nano : dnf install nano ======================================================================= Adicionar um usu\u00e1rio (userdc2) Adicionar um usu\u00e1rio para que o mesmo seja utilizado como replicador do sysvol (backup do ad-dc DC1), utilizando o comando useradd userdc2 Adicionar senha para o usu\u00e1rio criado: passwd userdc2 Insira uma senha para o usu\u00e1rio criado. Guarde a senha ======================================================================= Configura\u00e7\u00e3o de rede Verificar sua configura\u00e7\u00e3o de rede e DNS , bem como nome de dom\u00ednio . Uma das formas: Abrir um terminal e executar o nmtui : nmtui Selecione Editar uma conex\u00e3o . Ent\u00e3o a op\u00e7\u00e3o Editar . Verificar ou alterar seu endere\u00e7o ip , m\u00e1scara de sub-rede e seu Gateway . Na op\u00e7\u00e3o Servidor DNS : inserir PREFERENCIALMENTE o ip de seu Controlador de Dom\u00ednio Principal (seu DC1 ). N\u00e3o esquecer de inserir em Dom\u00ednios de pesquisa: seu.dom\u00ednio . V\u00e1 at\u00e9 o fim e selecione OK para salvar. Selecione Voltar e ent\u00e3o no menu, selecionar a op\u00e7\u00e3o: Definir nome de m\u00e1quina do sistema : dc2.seu.dominio. Agora selecione a op\u00e7\u00e3o: OK para salvar. Novamente selecione OK . Deve retornar para o terminal. ======================================================================= Editar o arquivo /etc /host : nano /etc/hosts Inserir os dados referentes ao seu servidor de Controlador de Dom\u00ednio 2: 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 # inserir os dados de seu server 10.1.1.38 dc2 dc2.seu.dominio Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Verificar processo do samba rodando: Veririficar se existe algum processo do samba rodando, com o comando: ps ax | egrep \"samba|smbd|nmbd|winbindd\" Remover qualquer configura\u00e7\u00e3o smb.conf que houver, checando com o comando: # smbd -b | grep \"CONFIGFILE\" CONFIGFILE: /usr/local/samba/etc/samba/smb.conf Remover todos arquivos de data base que houver. como .tdb * e .ldb *, listando com o comando: # smbd -b | egrep \"LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR\" LOCKDIR: /usr/local/samba/var/lock/ STATEDIR: /usr/local/samba/var/locks/ CACHEDIR: /usr/local/samba/var/cache/ PRIVATE_DIR: /usr/local/samba/private/ ======================================================================= Remover o arquivo /etc/krb5.conf Remover o arquivo /etc/krb5.conf se houver, com o comando: rm /etc/krb5.conf ======================================================================= Instalar plugins e habilitar reposit\u00f3rio PowerTools Instalar plugins e habilitar reposit\u00f3rio PowerTools com os comandos abaixo: dnf install dnf-plugins-core dnf install epel-release dnf config-manager --set-enabled powertools dnf update Checar os reposit\u00f3rios adicionados com o comando: dnf repolist O resultado deve ser algo como: id do repo nome do repo appstream Rocky Linux 8 - AppStream baseos Rocky Linux 8 - BaseOS devel Rocky Linux 8 - Devel WARNING! FOR BUILDROOT AND KOJI USE - epel Extra Packages for Enterprise Linux 8 - x86_64 - extras Rocky Linux 8 - Extras - powertools Rocky Linux 8 - PowerTools ======================================================================= Configurar servidor de horas (ntp): Listando as op\u00e7\u00f5es de hora local. timedatectl list-timezones Para setar o timezone desejado, usar o comando: timedatectl set-timezone America/Sao_Paulo Verificando o timezone setado: timedatectl Local time: qua 2023-04-12 09:04:22 -03 Universal time: qua 2023-04-12 12:04:22 UTC RTC time: qua 2023-04-12 12:00:16 Time zone: America/Sao_Paulo (-03, -0300) System clock synchronized: yes NTP service: active RTC in local TZ: no ======================================================================= Instalar as Depend\u00eancias dos Pacotes Instalar as depend\u00eancias dos pacotes para instalar e compilar o samba AD-DC . No terminal fazer um arquivo do tipo script execut\u00e1vel e inserir os comandos: nano depende.sh Inserir os comandos (copie e cole para seu arquivo): Atualizado em 03/02/2024 set -xueo pipefail dnf install -y epel-release dnf config-manager --enable epel dnf install -y yum-utils dnf config-manager --set-enabled powertools dnf update -y yum install -y \\ gcc.x86_64 \\ tar \\ python36.x86_64 \\ wget \\ nano \\ perl.x86_64 perl-Parse-Yapp.noarch \\ libacl.x86_64 \\ nfs4-acl-tools.x86_64 \\ gnutls-devel.x86_64 \\ zlib.x86_64 \\ krb5-devel.x86_64 \\ krb5-server \\ libblkid.x86_64 \\ dbus-devel.x86_64 \\ jansson-devel.x86_64 \\ readline.x86_64 \\ bsdtar.x86_64 \\ docbook-dtds.noarch \\ pam-devel \\ cups \\ python3-markdown \\ patchutils.x86_64 \\ gpgme-devel \\ flex \\ python3-iso8601.noarch \\ python3-cryptography.x86_64 \\ python36-devel \\ lmdb.x86_64 \\ libarchive-devel \\ libacl-devel \\ openldap-devel \\ python3-dns \\ perl-Convert-ASN1.noarch \\ rpcgen.x86_64 \\ perl-App-cpanminus \\ popt-devel.x86_64 \\ zlib-devel.x86_64 \\ lmdb-devel.x86_64 \\ bison-devel.x86_64 \\ libtasn1-tools \\ bison \\ perl-JSON \\ yum clean all \\ yum autoremove -y Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Transformar o arquivo em um execut\u00e1vel Transformar o arquivo de script em um execut\u00e1vel com o comando: chmod +x depende.sh Executar o arquivo com o comando: ./depende.sh ======================================================================= Fazer download do Samba Fazer download do samba ou a vers\u00e3o desejada com o comando: wget https://download.samba.org/pub/samba/stable/samba-4.18.0.tar.gz Descompcatar o arquivo baixado com o comando: tar -zxvf samba-nome-arquivo Mudar para o diret\u00f3rio onde foi descompactado: cd samba-nome-arquivo/ ======================================================================= Compilar o Samba Compilar o samba e fazer com que o arquivo de configua\u00e7\u00e3o (smb.conf) fique em: /etc/samba/smb.conf : ./configure --sysconfdir=/etc/samba/ Aguarde o procedimento terminar. ======================================================================= Comando make e make install Executar os comandos make e make install : make && make install Mudar para o diret\u00f3rio /root e editar o arquivo .bash_profile para que o comando samba-tool possa ser chamado na ra\u00edz do sistema. Execute os comandos: cd /root nano .bash_profile E inserir a linha: # User specific environment and startup programs PATH=$PATH:$HOME/bin #ESTA LINHA: PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH export PATH Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Arquivo Samba systemd Criar um arquivo de servi\u00e7o systemd para o Samba. Executar os comandos: systemctl mask smbd nmbd winbind systemctl disable smbd nmbd winbind Criar o arquivo com o editor nano em /etc/systemd/system/samba-ad-dc.service nano /etc/systemd/system/samba-ad-dc.service Copie e cole as linhas para seu arquivo: [Unit] Description=Samba Active Directory Domain Controller After=network.target remote-fs.target nss-lookup.target [Service] Type=forking ExecStart=/usr/local/samba/sbin/samba -D PIDFile=/usr/local/samba/var/run/samba.pid ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target Salvar o arquivo Para salvar: control+o e para sair: control+x ======================================================================= Recarregar o systemd Recarregar o systemd com o comando: systemctl daemon-reload Habilitar o samba-ad-dc para iniciar no boot do sistema: systemctl enable samba-ad-dc Restart o servi\u00e7o do samba-ad-dc com o comando: systemctl restart samba-ad-dc Para parar o servi\u00e7o samba-ad-dc executar o comando: systemctl stop samba-ad-dc Se necessitar desabilitar o servi\u00e7o samba-ad-dc, utilizar o comando: systemctl disable samba-ad-dc ======================================================================= Configurar o Firewall Adicionar servi\u00e7os no firewall, com o comando abaixo: Atualizado em 03/02/2024 firewall-cmd --add-service={dns,ldap,ldaps,kerberos} Abrir portas TCP : firewall-cmd --permanent --zone=public --add-port={53/tcp,135/tcp,139/tcp,389/tcp,445/tcp,465/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp}; Abrir portas UDP : firewall-cmd --permanent --zone=public --add-port={88/udp,123/udp,137/udp,138/udp,389/udp,464/udp}; Recarregar o Firewall: firewall-cmd --reload ======================================================================= Configurar o arquivo krb5.conf Copiar o arquivo krb5.conf para o diret\u00f3rio /etc utilizando o comando: cp /usr/local/samba/private/krb5.conf /etc/krb5.conf ======================================================================= Linkar lib libnss_winbind.so.2 Linkando a lib libnss_winbind.so.2 com os comandos: ln -s /usr/local/samba/lib/libnss_winbind.so.2 /lib64/ ln -s /lib64/libnss_winbind.so.2 /lib64/libnss_winbind.so ldconfig ======================================================================= Arquivo nsswitch Editar o arquivo /etc/nsswitch.conf para habilitar o nome dos usu\u00e1rios e grupos na esta\u00e7\u00e3o local. Usar o comando: nano /etc/nsswitch.conf Localize a linha: De: passwd: sss files systemd group: sss files systemd ALTERAR PARA: passwd: files winbind group: files winbind ====================================================================== Desabilitar SELinux Editar o arquivo /etc/selinux/config : nano /etc/selinux/config Encontre a linha e mude para disabled como mostra abaixo: # disabled - No SELinux policy is loaded. SELINUX=disabled Salve o arquivo: Para salvar: control+o e para sair control+x ====================================================================== Reinciar o samba ad-dc Reinciar o samba ad-dc com o comando: smbcontrol all reload-config Juntando-se (join AD) ao Active Directory (DC1) Executar o comando samba-tool domain join ao Active Directory (DC1) a partir de Seu Controlador de Dom\u00ednio (DC2) . Substitua seu.dom\u00ednio para seu cen\u00e1rio: samba-tool domain join seu.dominio DC -Uadministrator --realm=seu.dominio Com o comando acima o DC2 deve juntar-se ao DC1 (Controlador de Dom\u00ednio PRINCIPAL).","title":"Instalar Samba DC2-Replicador"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#configurar-samba-ad-dc-dc2-replicador","text":"Configurar o Rocky Linux para agir como um replicador do DC1 (backup) =======================================================================","title":"Configurar Samba AD-DC (DC2) Replicador"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#update-e-upgrade-do-sistema","text":"yum update -y && yum upgrade -y Instalar o editor de texto nano : dnf install nano =======================================================================","title":"Update e upgrade do sistema:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#adicionar-um-usuario-userdc2","text":"Adicionar um usu\u00e1rio para que o mesmo seja utilizado como replicador do sysvol (backup do ad-dc DC1), utilizando o comando useradd userdc2 Adicionar senha para o usu\u00e1rio criado: passwd userdc2 Insira uma senha para o usu\u00e1rio criado. Guarde a senha =======================================================================","title":"Adicionar um usu\u00e1rio (userdc2)"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#configuracao-de-rede","text":"Verificar sua configura\u00e7\u00e3o de rede e DNS , bem como nome de dom\u00ednio . Uma das formas: Abrir um terminal e executar o nmtui : nmtui Selecione Editar uma conex\u00e3o . Ent\u00e3o a op\u00e7\u00e3o Editar . Verificar ou alterar seu endere\u00e7o ip , m\u00e1scara de sub-rede e seu Gateway . Na op\u00e7\u00e3o Servidor DNS : inserir PREFERENCIALMENTE o ip de seu Controlador de Dom\u00ednio Principal (seu DC1 ). N\u00e3o esquecer de inserir em Dom\u00ednios de pesquisa: seu.dom\u00ednio . V\u00e1 at\u00e9 o fim e selecione OK para salvar. Selecione Voltar e ent\u00e3o no menu, selecionar a op\u00e7\u00e3o: Definir nome de m\u00e1quina do sistema : dc2.seu.dominio. Agora selecione a op\u00e7\u00e3o: OK para salvar. Novamente selecione OK . Deve retornar para o terminal. =======================================================================","title":"Configura\u00e7\u00e3o de rede"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#editar-o-arquivo-etc-host","text":"nano /etc/hosts Inserir os dados referentes ao seu servidor de Controlador de Dom\u00ednio 2: 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 # inserir os dados de seu server 10.1.1.38 dc2 dc2.seu.dominio Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Editar o arquivo /etc\u00a0/host:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#verificar-processo-do-samba-rodando","text":"Veririficar se existe algum processo do samba rodando, com o comando: ps ax | egrep \"samba|smbd|nmbd|winbindd\" Remover qualquer configura\u00e7\u00e3o smb.conf que houver, checando com o comando: # smbd -b | grep \"CONFIGFILE\" CONFIGFILE: /usr/local/samba/etc/samba/smb.conf Remover todos arquivos de data base que houver. como .tdb * e .ldb *, listando com o comando: # smbd -b | egrep \"LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR\" LOCKDIR: /usr/local/samba/var/lock/ STATEDIR: /usr/local/samba/var/locks/ CACHEDIR: /usr/local/samba/var/cache/ PRIVATE_DIR: /usr/local/samba/private/ =======================================================================","title":"Verificar processo do samba rodando:"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#remover-o-arquivo-etckrb5conf","text":"Remover o arquivo /etc/krb5.conf se houver, com o comando: rm /etc/krb5.conf =======================================================================","title":"Remover o arquivo /etc/krb5.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#instalar-plugins-e-habilitar-repositorio-powertools","text":"Instalar plugins e habilitar reposit\u00f3rio PowerTools com os comandos abaixo: dnf install dnf-plugins-core dnf install epel-release dnf config-manager --set-enabled powertools dnf update Checar os reposit\u00f3rios adicionados com o comando: dnf repolist O resultado deve ser algo como: id do repo nome do repo appstream Rocky Linux 8 - AppStream baseos Rocky Linux 8 - BaseOS devel Rocky Linux 8 - Devel WARNING! FOR BUILDROOT AND KOJI USE - epel Extra Packages for Enterprise Linux 8 - x86_64 - extras Rocky Linux 8 - Extras - powertools Rocky Linux 8 - PowerTools =======================================================================","title":"Instalar plugins e habilitar reposit\u00f3rio PowerTools"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#configurar-servidor-de-horas-ntp","text":"Listando as op\u00e7\u00f5es de hora local. timedatectl list-timezones Para setar o timezone desejado, usar o comando: timedatectl set-timezone America/Sao_Paulo Verificando o timezone setado: timedatectl Local time: qua 2023-04-12 09:04:22 -03 Universal time: qua 2023-04-12 12:04:22 UTC RTC time: qua 2023-04-12 12:00:16 Time zone: America/Sao_Paulo (-03, -0300) System clock synchronized: yes NTP service: active RTC in local TZ: no =======================================================================","title":"Configurar servidor de horas (ntp):"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#instalar-as-dependencias-dos-pacotes","text":"Instalar as depend\u00eancias dos pacotes para instalar e compilar o samba AD-DC . No terminal fazer um arquivo do tipo script execut\u00e1vel e inserir os comandos: nano depende.sh Inserir os comandos (copie e cole para seu arquivo): Atualizado em 03/02/2024 set -xueo pipefail dnf install -y epel-release dnf config-manager --enable epel dnf install -y yum-utils dnf config-manager --set-enabled powertools dnf update -y yum install -y \\ gcc.x86_64 \\ tar \\ python36.x86_64 \\ wget \\ nano \\ perl.x86_64 perl-Parse-Yapp.noarch \\ libacl.x86_64 \\ nfs4-acl-tools.x86_64 \\ gnutls-devel.x86_64 \\ zlib.x86_64 \\ krb5-devel.x86_64 \\ krb5-server \\ libblkid.x86_64 \\ dbus-devel.x86_64 \\ jansson-devel.x86_64 \\ readline.x86_64 \\ bsdtar.x86_64 \\ docbook-dtds.noarch \\ pam-devel \\ cups \\ python3-markdown \\ patchutils.x86_64 \\ gpgme-devel \\ flex \\ python3-iso8601.noarch \\ python3-cryptography.x86_64 \\ python36-devel \\ lmdb.x86_64 \\ libarchive-devel \\ libacl-devel \\ openldap-devel \\ python3-dns \\ perl-Convert-ASN1.noarch \\ rpcgen.x86_64 \\ perl-App-cpanminus \\ popt-devel.x86_64 \\ zlib-devel.x86_64 \\ lmdb-devel.x86_64 \\ bison-devel.x86_64 \\ libtasn1-tools \\ bison \\ perl-JSON \\ yum clean all \\ yum autoremove -y Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Instalar as Depend\u00eancias dos Pacotes"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#transformar-o-arquivo-em-um-executavel","text":"Transformar o arquivo de script em um execut\u00e1vel com o comando: chmod +x depende.sh Executar o arquivo com o comando: ./depende.sh =======================================================================","title":"Transformar o arquivo em um execut\u00e1vel"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#fazer-download-do-samba","text":"Fazer download do samba ou a vers\u00e3o desejada com o comando: wget https://download.samba.org/pub/samba/stable/samba-4.18.0.tar.gz Descompcatar o arquivo baixado com o comando: tar -zxvf samba-nome-arquivo Mudar para o diret\u00f3rio onde foi descompactado: cd samba-nome-arquivo/ =======================================================================","title":"Fazer download do Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#compilar-o-samba","text":"Compilar o samba e fazer com que o arquivo de configua\u00e7\u00e3o (smb.conf) fique em: /etc/samba/smb.conf : ./configure --sysconfdir=/etc/samba/ Aguarde o procedimento terminar. =======================================================================","title":"Compilar o Samba"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#comando-make-e-make-install","text":"Executar os comandos make e make install : make && make install Mudar para o diret\u00f3rio /root e editar o arquivo .bash_profile para que o comando samba-tool possa ser chamado na ra\u00edz do sistema. Execute os comandos: cd /root nano .bash_profile E inserir a linha: # User specific environment and startup programs PATH=$PATH:$HOME/bin #ESTA LINHA: PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH export PATH Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Comando make e make install"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#arquivo-samba-systemd","text":"Criar um arquivo de servi\u00e7o systemd para o Samba. Executar os comandos: systemctl mask smbd nmbd winbind systemctl disable smbd nmbd winbind Criar o arquivo com o editor nano em /etc/systemd/system/samba-ad-dc.service nano /etc/systemd/system/samba-ad-dc.service Copie e cole as linhas para seu arquivo: [Unit] Description=Samba Active Directory Domain Controller After=network.target remote-fs.target nss-lookup.target [Service] Type=forking ExecStart=/usr/local/samba/sbin/samba -D PIDFile=/usr/local/samba/var/run/samba.pid ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target Salvar o arquivo Para salvar: control+o e para sair: control+x =======================================================================","title":"Arquivo Samba systemd"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#recarregar-o-systemd","text":"Recarregar o systemd com o comando: systemctl daemon-reload Habilitar o samba-ad-dc para iniciar no boot do sistema: systemctl enable samba-ad-dc Restart o servi\u00e7o do samba-ad-dc com o comando: systemctl restart samba-ad-dc Para parar o servi\u00e7o samba-ad-dc executar o comando: systemctl stop samba-ad-dc Se necessitar desabilitar o servi\u00e7o samba-ad-dc, utilizar o comando: systemctl disable samba-ad-dc =======================================================================","title":"Recarregar o systemd"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#configurar-o-firewall","text":"Adicionar servi\u00e7os no firewall, com o comando abaixo: Atualizado em 03/02/2024 firewall-cmd --add-service={dns,ldap,ldaps,kerberos} Abrir portas TCP : firewall-cmd --permanent --zone=public --add-port={53/tcp,135/tcp,139/tcp,389/tcp,445/tcp,465/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp}; Abrir portas UDP : firewall-cmd --permanent --zone=public --add-port={88/udp,123/udp,137/udp,138/udp,389/udp,464/udp}; Recarregar o Firewall: firewall-cmd --reload =======================================================================","title":"Configurar o Firewall"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#configurar-o-arquivo-krb5conf","text":"Copiar o arquivo krb5.conf para o diret\u00f3rio /etc utilizando o comando: cp /usr/local/samba/private/krb5.conf /etc/krb5.conf =======================================================================","title":"Configurar o arquivo krb5.conf"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#linkar-lib-libnss_winbindso2","text":"Linkando a lib libnss_winbind.so.2 com os comandos: ln -s /usr/local/samba/lib/libnss_winbind.so.2 /lib64/ ln -s /lib64/libnss_winbind.so.2 /lib64/libnss_winbind.so ldconfig =======================================================================","title":"Linkar lib libnss_winbind.so.2"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#arquivo-nsswitch","text":"Editar o arquivo /etc/nsswitch.conf para habilitar o nome dos usu\u00e1rios e grupos na esta\u00e7\u00e3o local. Usar o comando: nano /etc/nsswitch.conf Localize a linha: De: passwd: sss files systemd group: sss files systemd ALTERAR PARA: passwd: files winbind group: files winbind ======================================================================","title":"Arquivo nsswitch"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#desabilitar-selinux","text":"Editar o arquivo /etc/selinux/config : nano /etc/selinux/config Encontre a linha e mude para disabled como mostra abaixo: # disabled - No SELinux policy is loaded. SELINUX=disabled Salve o arquivo: Para salvar: control+o e para sair control+x ======================================================================","title":"Desabilitar SELinux"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#reinciar-o-samba-ad-dc","text":"Reinciar o samba ad-dc com o comando: smbcontrol all reload-config","title":"Reinciar o samba ad-dc"},{"location":"rocky-linux-8-7-samba-ad-dc-complete/samba-ad2/#juntando-se-join-ad-ao-active-directory-dc1","text":"Executar o comando samba-tool domain join ao Active Directory (DC1) a partir de Seu Controlador de Dom\u00ednio (DC2) . Substitua seu.dom\u00ednio para seu cen\u00e1rio: samba-tool domain join seu.dominio DC -Uadministrator --realm=seu.dominio Com o comando acima o DC2 deve juntar-se ao DC1 (Controlador de Dom\u00ednio PRINCIPAL).","title":"Juntando-se (join AD) ao Active Directory (DC1)"}]}